!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a.AV=a.AV||{},a.AV.realtime=b())}(this,function(){"use strict";function a(a,b){return b={exports:{}},a(b,b.exports,h),b.exports}function b(){}function c(a){return/^\{.*\}$/.test(a)}function d(){return(new Date).getTime()}function e(a){var b=function(a){return"string"==typeof a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):a};if("object"===("undefined"==typeof a?"undefined":f(a))){for(var c in a)a[c]=tool.encodeHTML(a[c]);return a}return b(a)}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},g="undefined"!=typeof window?window:"undefined"!=typeof g?g:this,h="undefined"!=typeof window?window:"undefined"!=typeof g?g:this,i="2.3.5",j=Object.freeze({noop:b,isJSONString:c,now:d,encodeHTML:e}),k=a(function(a,b){b.XMLHttpRequest=window.XMLHttpRequest||window.XDomainRequest}),l=k.XMLHttpRequest,m=function(a,b){"string"==typeof a&&(a={url:a});var c=a.url,d=a.method||"get",e=new l;e.open(d,c),e.onload=function(a){e.status>=200&&e.status<300?b(null,JSON.parse(e.responseText)):b(JSON.parse(e.responseText))},e.onerror=function(a){throw b(a||{}),new Error("Network error.")},e.onprogress=function(){},e.ontimeout=function(){},e.timeout=0;var f=JSON.stringify(a.data);e.send(f)},n=function(){function a(a){var b=[],c=0,d=a.length;if(d){for(;d>c;c++)a[c]&&b.push(a[c]);return b}return null}var b={},c={},d=function(a,d,e){if(!a)throw new Error("No event name.");if(!d)throw new Error("No callback function.");var f,g,h,i=a.split(/\s+/);e&&(g=e.once,h=e.single),f=g?c:b;for(var j=0,k=i.length;k>j;j++)if(i[j]){var l=f[i[j]];if(l||(l=[],f[i[j]]=l),h){for(var m=!1,n=0,o=l.length;o>n;n++)if(l[n].toString()===d.toString()){m=!0;break}m||l.push(d)}else l.push(d)}},e=function(a,d,e){var f,g;if(e&&(g=e.once),f=g?c:b,f[a])for(var h=0,i=f[a].length;i>h;h++)if(f[a][h]===d){f[a][h]=null;break}};return{on:function(a,b){return d(a,b),this},once:function(a,b){return d(a,b,{once:!0}),this},_one:function(a,b){d(a,b,{single:!0})},emit:function(d,f){if(!d)throw new Error("No emit event name.");var g=0,h=0;if(b[d]){for(g=0,h=b[d].length;h>g;g++)b[d][g]&&b[d][g].call(this,f);b[d]=a(b[d])}if(c[d]){for(g=0,h=c[d].length;h>g;g++)c[d][g]&&(c[d][g].call(this,f),e(d,c[d][g],{once:!0}));c[d]=a(c[d])}return this},off:function(a,b){return e(a,b),this}}},o=(a(function(a,b,c){(function(){function b(a){return"function"==typeof a||"object"===("undefined"==typeof a?"undefined":f(a))&&null!==a}function d(a){return"function"==typeof a}function e(a){return"object"===("undefined"==typeof a?"undefined":f(a))&&null!==a}function g(){}function h(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1}function i(a){var b=a._promiseCallbacks;return b||(b=a._promiseCallbacks={}),b}function j(a,b){return"onerror"===a?void ya.on("error",b):2!==arguments.length?ya[a]:void(ya[a]=b)}function k(){setTimeout(function(){for(var a,b=0;b<za.length;b++){a=za[b];var c=a.payload;c.guid=c.key+c.id,c.childGuid=c.key+c.childId,c.error&&(c.stack=c.error.stack),ya.trigger(a.name,a.payload)}za.length=0},50)}function l(a,b,c){1===za.push({name:a,payload:{key:b._guidKey,id:b._id,eventName:a,detail:b._result,childId:c&&c._id,label:b._label,timeStamp:va(),error:ya["instrument-with-stack"]?new Error(b._label):null}})&&k()}function m(){return new TypeError("A promises callback cannot return that same promise.")}function n(){}function o(a){try{return a.then}catch(b){return Ea.error=b,Ea}}function p(a,b,c,d){try{a.call(b,c,d)}catch(e){return e}}function q(a,b,c){ya.async(function(a){var d=!1,e=p(c,b,function(c){d||(d=!0,b!==c?t(a,c):v(a,c))},function(b){d||(d=!0,w(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,w(a,e))},a)}function r(a,b){b._state===Ca?v(a,b._result):b._state===Da?(b._onError=null,w(a,b._result)):x(b,void 0,function(c){b!==c?t(a,c):v(a,c)},function(b){w(a,b)})}function s(a,b){if(b.constructor===a.constructor)r(a,b);else{var c=o(b);c===Ea?w(a,Ea.error):void 0===c?v(a,b):d(c)?q(a,b,c):v(a,b)}}function t(a,c){a===c?v(a,c):b(c)?s(a,c):v(a,c)}function u(a){a._onError&&a._onError(a._result),y(a)}function v(a,b){a._state===Ba&&(a._result=b,a._state=Ca,0===a._subscribers.length?ya.instrument&&Aa("fulfilled",a):ya.async(y,a))}function w(a,b){a._state===Ba&&(a._state=Da,a._result=b,ya.async(u,a))}function x(a,b,c,d){var e=a._subscribers,f=e.length;a._onError=null,e[f]=b,e[f+Ca]=c,e[f+Da]=d,0===f&&a._state&&ya.async(y,a)}function y(a){var b=a._subscribers,c=a._state;if(ya.instrument&&Aa(c===Ca?"fulfilled":"rejected",a),0!==b.length){for(var d,e,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?B(c,d,e,f):e(f);a._subscribers.length=0}}function z(){this.error=null}function A(a,b){try{return a(b)}catch(c){return Fa.error=c,Fa}}function B(a,b,c,e){var f,g,h,i,j=d(c);if(j){if(f=A(c,e),f===Fa?(i=!0,g=f.error,f=null):h=!0,b===f)return void w(b,m())}else f=e,h=!0;b._state!==Ba||(j&&h?t(b,f):i?w(b,g):a===Ca?v(b,f):a===Da&&w(b,f))}function C(a,b){var c=!1;try{b(function(b){c||(c=!0,t(a,b))},function(b){c||(c=!0,w(a,b))})}catch(d){w(a,d)}}function D(a,b,c){return a===Ca?{state:"fulfilled",value:c}:{state:"rejected",reason:c}}function E(a,b,c,d){var e=this;e._instanceConstructor=a,e.promise=new a(n,d),e._abortOnReject=c,e._validateInput(b)?(e._input=b,e.length=b.length,e._remaining=b.length,e._init(),0===e.length?v(e.promise,e._result):(e.length=e.length||0,e._enumerate(),0===e._remaining&&v(e.promise,e._result))):w(e.promise,e._validationError())}function F(a,b){return new Ga(this,a,!0,b).promise}function G(a,b){function c(a){t(f,a)}function d(a){w(f,a)}var e=this,f=new e(n,b);if(!ua(a))return w(f,new TypeError("You must pass an array to race.")),f;for(var g=a.length,h=0;f._state===Ba&&g>h;h++)x(e.resolve(a[h]),void 0,c,d);return f}function H(a,b){var c=this;if(a&&"object"===("undefined"==typeof a?"undefined":f(a))&&a.constructor===c)return a;var d=new c(n,b);return t(d,a),d}function I(a,b){var c=this,d=new c(n,b);return w(d,a),d}function J(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function K(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function L(a,b){var c=this;c._id=Ma++,c._label=b,c._state=void 0,c._result=void 0,c._subscribers=[],ya.instrument&&Aa("created",c),n!==a&&(d(a)||J(),c instanceof L||K(),C(c,a))}function M(a,b,c){this._superConstructor(a,b,!1,c)}function N(a,b){return new M(Na,a,b).promise}function O(a,b){return Na.all(a,b)}function P(a,b){Za[Sa]=a,Za[Sa+1]=b,Sa+=2,2===Sa&&Pa()}function Q(){var a=process.nextTick,b=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(b)&&"0"===b[1]&&"10"===b[2]&&(a=setImmediate),function(){a(V)}}function R(){return function(){Oa(V)}}function S(){var a=0,b=new Wa(V),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function T(){var a=new MessageChannel;return a.port1.onmessage=V,function(){a.port2.postMessage(0)}}function U(){return function(){setTimeout(V,1)}}function V(){for(var a=0;Sa>a;a+=2){var b=Za[a],c=Za[a+1];b(c),Za[a]=void 0,Za[a+1]=void 0}Sa=0}function W(){try{var a=require,b=a("vertx");return Oa=b.runOnLoop||b.runOnContext,R()}catch(c){return U()}}function X(a){var b={};return b.promise=new Na(function(a,c){b.resolve=a,b.reject=c},a),b}function Y(a,b,c){return Na.all(a,c).then(function(a){if(!d(b))throw new TypeError("You must pass a function as filter's second argument.");for(var e=a.length,f=new Array(e),g=0;e>g;g++)f[g]=b(a[g]);return Na.all(f,c).then(function(b){for(var c=new Array(e),d=0,f=0;e>f;f++)b[f]&&(c[d]=a[f],d++);return c.length=d,c})})}function Z(a,b,c){this._superConstructor(a,b,!0,c)}function $(a,b,c){this._superConstructor(a,b,!1,c)}function _(a,b){return new $(Na,a,b).promise}function aa(a,b){return new ab(Na,a,b).promise}function ba(a,b,c){return Na.all(a,c).then(function(a){if(!d(b))throw new TypeError("You must pass a function as map's second argument.");for(var e=a.length,f=new Array(e),g=0;e>g;g++)f[g]=b(a[g]);return Na.all(f,c)})}function ca(){this.value=void 0}function da(a){try{return a.then}catch(b){return fb.value=b,fb}}function ea(a,b,c){try{a.apply(b,c)}catch(d){return fb.value=d,fb}}function fa(a,b){for(var c,d,e={},f=a.length,g=new Array(f),h=0;f>h;h++)g[h]=a[h];for(d=0;d<b.length;d++)c=b[d],e[c]=g[d+1];return e}function ga(a){for(var b=a.length,c=new Array(b-1),d=1;b>d;d++)c[d-1]=a[d];return c}function ha(a,b){return{then:function(c,d){return a.call(b,c,d)}}}function ia(a,b){var c=function(){for(var c,d=this,e=arguments.length,f=new Array(e+1),g=!1,h=0;e>h;++h){if(c=arguments[h],!g){if(g=la(c),g===gb){var i=new Na(n);return w(i,gb.value),i}g&&g!==!0&&(c=ha(g,c))}f[h]=c}var j=new Na(n);return f[e]=function(a,c){a?w(j,a):void 0===b?t(j,c):b===!0?t(j,ga(arguments)):ua(b)?t(j,fa(arguments,b)):t(j,c)},g?ka(j,f,a,d):ja(j,f,a,d)};return c.__proto__=a,c}function ja(a,b,c,d){var e=ea(c,d,b);return e===fb&&w(a,e.value),a}function ka(a,b,c,d){return Na.all(b).then(function(b){var e=ea(c,d,b);return e===fb&&w(a,e.value),a})}function la(a){return a&&"object"===("undefined"==typeof a?"undefined":f(a))?a.constructor===Na?!0:da(a):!1}function ma(a,b){return Na.race(a,b)}function na(a,b){return Na.reject(a,b)}function oa(a,b){return Na.resolve(a,b)}function pa(a){throw setTimeout(function(){throw a}),a}function qa(a,b){ya.async(a,b)}function ra(){ya.on.apply(ya,arguments)}function sa(){ya.off.apply(ya,arguments)}var ta;ta=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};var ua=ta,va=Date.now||function(){return(new Date).getTime()},wa=Object.create||function(a){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!==("undefined"==typeof a?"undefined":f(a)))throw new TypeError("Argument must be an object");return g.prototype=a,new g},xa={mixin:function(a){return a.on=this.on,a.off=this.off,a.trigger=this.trigger,a._promiseCallbacks=void 0,a},on:function(a,b){if("function"!=typeof b)throw new TypeError("Callback must be a function");var c,d=i(this);c=d[a],c||(c=d[a]=[]),-1===h(c,b)&&c.push(b)},off:function(a,b){var c,d,e=i(this);return b?(c=e[a],d=h(c,b),void(-1!==d&&c.splice(d,1))):void(e[a]=[])},trigger:function(a,b,c){var d,e,f=i(this);if(d=f[a])for(var g=0;g<d.length;g++)(e=d[g])(b,c)}},ya={instrument:!1};xa.mixin(ya);var za=[],Aa=l,Ba=void 0,Ca=1,Da=2,Ea=new z,Fa=new z,Ga=E;E.prototype._validateInput=function(a){return ua(a)},E.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},E.prototype._init=function(){this._result=new Array(this.length)},E.prototype._enumerate=function(){for(var a=this,b=a.length,c=a.promise,d=a._input,e=0;c._state===Ba&&b>e;e++)a._eachEntry(d[e],e)},E.prototype._eachEntry=function(a,b){var c=this,d=c._instanceConstructor;e(a)?a.constructor===d&&a._state!==Ba?(a._onError=null,c._settledAt(a._state,b,a._result)):c._willSettleAt(d.resolve(a),b):(c._remaining--,c._result[b]=c._makeResult(Ca,b,a))},E.prototype._settledAt=function(a,b,c){var d=this,e=d.promise;e._state===Ba&&(d._remaining--,d._abortOnReject&&a===Da?w(e,c):d._result[b]=d._makeResult(a,b,c)),0===d._remaining&&v(e,d._result)},E.prototype._makeResult=function(a,b,c){return c},E.prototype._willSettleAt=function(a,b){var c=this;x(a,void 0,function(a){c._settledAt(Ca,b,a)},function(a){c._settledAt(Da,b,a)})};var Ha=F,Ia=G,Ja=H,Ka=I,La="rsvp_"+va()+"-",Ma=0,Na=L;L.cast=Ja,L.all=Ha,L.race=Ia,L.resolve=Ja,L.reject=Ka,L.prototype={constructor:L,_guidKey:La,_onError:function(a){var b=this;ya.after(function(){b._onError&&ya.trigger("error",a,b._label)})},then:function(a,b,c){var d=this,e=d._state;if(e===Ca&&!a||e===Da&&!b)return ya.instrument&&Aa("chained",d,d),d;d._onError=null;var f=new d.constructor(n,c),g=d._result;if(ya.instrument&&Aa("chained",d,f),e){var h=arguments[e-1];ya.async(function(){B(e,f,h,g)})}else x(d,f,a,b);return f},"catch":function(a,b){return this.then(void 0,a,b)},"finally":function(a,b){var c=this,d=c.constructor;return c.then(function(b){return d.resolve(a()).then(function(){return b})},function(b){return d.resolve(a()).then(function(){throw b})},b)}},M.prototype=wa(Ga.prototype),M.prototype._superConstructor=Ga,M.prototype._makeResult=D,M.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var Oa,Pa,Qa=N,Ra=O,Sa=0,Ta=({}.toString,P),Ua="undefined"!=typeof window?window:void 0,Va=Ua||{},Wa=Va.MutationObserver||Va.WebKitMutationObserver,Xa="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Ya="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Za=new Array(1e3);Pa=Xa?Q():Wa?S():Ya?T():void 0===Ua&&"function"==typeof require?W():U();var $a=X,_a=Y,ab=Z;Z.prototype=wa(Ga.prototype),Z.prototype._superConstructor=Ga,Z.prototype._init=function(){this._result={}},Z.prototype._validateInput=function(a){return a&&"object"===("undefined"==typeof a?"undefined":f(a))},Z.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},Z.prototype._enumerate=function(){var a=this,b=a.promise,c=a._input,d=[];for(var e in c)b._state===Ba&&Object.prototype.hasOwnProperty.call(c,e)&&d.push({position:e,entry:c[e]});var f=d.length;a._remaining=f;for(var g,h=0;b._state===Ba&&f>h;h++)g=d[h],a._eachEntry(g.entry,g.position)},$.prototype=wa(ab.prototype),$.prototype._superConstructor=Ga,$.prototype._makeResult=D,$.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var bb,cb=_,db=aa,eb=ba,fb=new ca,gb=new ca,hb=ia;if("object"===("undefined"==typeof self?"undefined":f(self)))bb=self;else{if("object"!==("undefined"==typeof c?"undefined":f(c)))throw new Error("no global: `self` or `global` found");bb=c}var ib=bb,jb=ma,kb=na,lb=oa,mb=pa;ya.async=Ta,ya.after=function(a){setTimeout(a,0)};if("undefined"!=typeof window&&"object"===f(window.__PROMISE_INSTRUMENTATION__)){var nb=window.__PROMISE_INSTRUMENTATION__;j("instrument",!0);for(var ob in nb)nb.hasOwnProperty(ob)&&ra(ob,nb[ob])}var pb={race:jb,Promise:Na,allSettled:Qa,hash:db,hashSettled:cb,denodeify:hb,on:ra,off:sa,map:eb,filter:_a,resolve:lb,reject:kb,all:Ra,rethrow:mb,defer:$a,EventTarget:xa,configure:j,async:qa};"function"==typeof define&&define.amd?define(function(){return pb}):"undefined"!=typeof a&&a.exports?a.exports=pb:"undefined"!=typeof ib&&(ib.RSVP=pb)}).call(this)}),Object.assign),p={heartbeatsTime:6e4,WebSocket:g.WebSocket||g.MozWebSocket||require("ws")},q={},r={open:"open",reuse:"reuse",close:"close",create:"create",join:"join",left:"left",invited:"invited",kicked:"kicked",membersjoined:"membersjoined",membersleft:"membersleft",message:"message",receipt:"receipt",update:"update",error:"error"},s=function(a){var b=function(b,c,d,e){var f,g,h,i=[];switch("string"==typeof c?i.push(c):i=c,f={cid:b,members:i,serialId:q.getSerialId(a)},e){case"add":h="conv-added",q.convAdd(a,f);break;case"remove":h="conv-removed",q.convRemove(a,f)}return g=function(b){b.i===f.serialId&&(d&&d(b),a.ec.off(h,g))},a.ec.on(h,g),this};return{id:"",attr:{},add:function(a,c){return b(this.id,a,c,"add"),this},remove:function(a,c){return b(this.id,a,c,"remove"),this},join:function(b){return this.add(a.options.peerId,b),this},leave:function(b){return this.remove(a.options.peerId,b),this},send:function(b,c,d){var e,f={},g=this;switch(arguments.length){case 2:e=c;break;case 3:f=c,e=d}if(f.cid=g.id,f.serialId=q.getSerialId(a),f.type?f.data=q.setMediaMsg(a,f.type,b):"string"==typeof b?f.data=b:f.data=JSON.stringify(b),f.receipt&&(f.receipt=1),!f["transient"]){var h=function i(b){b.i===f.serialId&&(e&&e(b),a.ec.off("ack",i))};a.ec.on("ack",h)}return q.send(a,f,e),this},log:function(b,c){var d={};switch(arguments.length){case 1:c=b;break;case 2:d=b}d.cid=d.cid||this.id,d.serialId=d.serialId||q.getSerialId(a);var e=function f(b){if(b.i===d.serialId){if(c){var e=!0,g=!1,h=void 0;try{for(var i,j=b.logs[Symbol.iterator]();!(e=(i=j.next()).done);e=!0){var k=i.value;k.data=q.getMediaMsg(a,k.data),k.fromPeerId=k.from,k.msg=k.data}}catch(l){g=!0,h=l}finally{try{!e&&j["return"]&&j["return"]()}finally{if(g)throw h}}c(b.logs)}a.ec.off("logs",f)}};return a.ec.on("logs",e),q.convLog(a,d),this},receive:function(b){var c=this.id;return a.ec.on(r.message,function(a){c===a.cid&&b(a)}),this},receipt:function(b){var c=this.id;return a.ec.on(r.receipt,function(a){c===a.cid&&b(a)}),this},list:function(b){var c={},d=this.id;c.where={objectId:d},c.serialId=q.getSerialId(a);var e=function f(d){d.i===c.serialId&&(b&&b(d.results.length?d.results[0].m:[]),a.ec.off("conv-results",f))};return a.ec.on("conv-results",e),q.convQuery(a,c),this},count:function(b){var c=this.id,d={cid:c,serialId:q.getSerialId(a)},e=function f(c){c.i===d.serialId&&(b&&b(c.count),a.ec.off("conv-result",f))};return a.ec.on("conv-result",e),q.convCount(a,d),this},update:function(b,c){var d=this.id,e={cid:d,data:b,serialId:q.getSerialId(a)},f=function g(b){b.i===e.serialId&&(c&&c(b),a.ec.off("conv-updated",g))};return a.ec.on("conv-updated",f),q.convUpdate(a,e),this}}},t=function(){var a={options:void 0,ws:void 0,ec:void 0,conv:{},openFlag:!1,closeFlag:!1,reuseTimer:void 0,reuseFlag:!1,serialId:2015};return{clientId:"",cache:a,open:function(a){var b=this,c=this.cache;return c.closeFlag=!1,q.getServer(c,c.options,function(a){a&&q.connect(c,{server:c.server})}),a&&c.ec.once(r.open,a),c.ec.once(r.reuse,function(){c.reuseTimer&&clearTimeout(c.reuseTimer),c.reuseTimer=setTimeout(function(){b.open()},5e3)}),this},close:function(){var a=this.cache;if(!a.openFlag)throw new Error("Must call after open() has successed.");return a.closeFlag=!0,q.closeSession(a),a.ws.close(),this},on:function(a,b){return this.cache.ec.on(a,b),this},once:function(a,b){return this.cache.ec.once(a,b),this},emit:function(a,b){return this.cache.ec.emit(a,b),this},off:function(a,b){return this.cache.ec.off(a,b),this},room:function(a,b){var c=this.cache;if(!c.openFlag)throw new Error("Must call after open() has successed.");var d;if("string"==typeof a){var e=a;d=c.conv[e]?c.conv[e]:s(c),this.query({where:{objectId:e}},function(a){a.length&&(d.id=e,d.name=a[0].name,d.attr=a[0].attr,c.conv[e]=d),b&&b(a.length?d:null)})}else{if(!a)throw new Error("Createing room must have a callback function.");var f;"function"==typeof a?b=a:f=a,f={name:f.name||"",members:f.members||[],attr:f.attr||{},"transient":f["transient"]||!1,unique:f.unique||!1,serialId:q.getSerialId(c)},d=s(c),q.startConv(c,f,b);var g=function h(a){a.i===f.serialId&&(d.id=a.cid,d.name=f.name,d.attr=f.attr,c.conv[d.id]=d,b&&b(d),c.ec.emit(r.create,a),c.ec.off("conv-started",h))};c.ec.on("conv-started",g)}return d},conv:function(){return this.room.apply(this,arguments)},query:function(a,b){var c=this.cache;if(!c.openFlag)throw new Error("Must call after open() has successed.");var d={};switch(arguments.length){case 1:b=a;break;case 2:d=a}d.serialId=q.getSerialId(c);var e=function f(a){a.i===d.serialId&&(b&&b(a.results),c.ec.off("conv-results",f))};return c.ec.on("conv-results",e),d.where||(d.where={},d.where.m=c.options.peerId),q.convQuery(c,d),this},ping:function(a,b){var c=this.cache;if(!c.openFlag)throw new Error("Must call after open() has successed.");if(!b)throw new Error("Ping must have callback.");var d=[];"string"==typeof a?d.push(a):d=a;var e={serialId:q.getSerialId(c),peerIdList:d},f=function g(a){a.i===e.serialId&&(b(a.onlineSessionPeerIds),c.ec.off("session-query-result",g))};return c.ec.on("session-query-result",f),q.querySession(c,e),this}}},u=function(a,b){if("object"!==("undefined"==typeof a?"undefined":f(a)))throw new Error("realtime need a argument at least.");if(!a.appId)throw new Error("Options must have appId.");if(p.WebSocket){var c=p.WebSocket.loadFlashPolicyFile?!1:!0;a={appId:a.appId,peerId:a.clientId,encodeHTML:a.encodeHTML||!1,auth:a.auth,secure:"undefined"==typeof a.secure?c:a.secure,region:a.region||"cn"};var d=t();return d.clientId=a.peerId,d.cache.options=a,d.cache.ec=n(),d.cache.authFun=a.auth,d.open(b),d}console.error("Browser must support WebSocket, please read LeanCloud doc and use plugin.")};return u.version=i,u._tool=j,u._engine=q,u.config=function(a){o(p,a)},q.wsOpen=function(a){q.bindEvent(a),q.openSession(a,{serialId:q.getSerialId(a)}),q.heartbeats(a),q.guard(a)},q.wsClose=function(a,b){a.ec.emit(r.close,b)},q.wsMessage=function(a,b){var c=JSON.parse(b.data);if(c.cmd){var d=c.cmd;c.op&&(d+="-"+c.op),a.ec.emit(d,c)}},q.wsError=function(a,b){throw a.ec.emit(r.error,b),b},q.wsSend=function(a,b){if(!a.closeFlag){if(!a.ws)throw new Error('The realtimeObject must opened first. Please listen to the "open" event.');b.peerId=a.options.peerId,a.ws.send(JSON.stringify(b))}},q.createSocket=function(a,b){a.ws&&a.ws.close();var c=new p.WebSocket(b);a.ws=c,c.addEventListener("open",function(){q.wsOpen(a)}),c.addEventListener("close",function(b){q.wsClose(a,b)}),c.addEventListener("message",function(b){q.wsMessage(a,b)}),c.addEventListener("error",function(b){q.wsError(a,b)})},q.heartbeats=function(a){if(!a.openFlag){var b;a.ws.addEventListener("message",function(){b&&clearTimeout(b),b=setTimeout(function(){a.ws.send("{}")},p.heartbeatsTime)})}},q.guard=function(a){if(!a.openFlag){var b,c=18e4;a.ws.addEventListener("message",function(){b&&clearTimeout(b),b=setTimeout(function(){a.closeFlag||a.reuseFlag||(a.reuseFlag=!0,a.ec.emit(r.reuse))},c)}),a.ec.on(r.close+" session-closed",function(){a.closeFlag||a.reuseFlag||(a.reuseFlag=!0,a.ec.emit(r.reuse))})}},q.connect=function(a,b){var c=b.server;if(!(c&&d()<=c.expires))throw a.ec.emit(r.error),new Error("WebSocket connet failed.");q.createSocket(a,c.server)},q.getServer=function(a,b,c){var e=b.appId,f=b.secure,g="",h="//";f&&(h="https://");var i="";switch(b.region){case"cn":i="g0";break;case"us":i="a0";break;default:throw new Error("There is no this region.")}g=h+"router-"+i+"-push.leancloud.cn/v1/route",g+="?_t="+d()+"&appId="+e,f&&(g+="&secure=1"),m(g,function(b,e){e?(e.expires=d()+1e3*e.ttl,a.server=e,c(e)):a.ec.emit(r.error)})},q.openSession=function(a,b){var c={cmd:"session",op:"open",appId:a.options.appId,ua:"js/"+i,i:b.serialId};a.authFun?a.authFun({clientId:a.options.peerId},function(b){if(!b||!b.signature)throw new Error("Session open denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,q.wsSend(a,c)}):q.wsSend(a,c)},q.closeSession=function(a){q.wsSend(a,a,{cmd:"session",op:"close"})},q.startConv=function(a,b){var c={cmd:"conv",op:"start",m:b.members,attr:{name:b.name||"",attr:b.attr||{}},i:b.serialId,unique:b.unique||!1,"transient":b["transient"]||!1};a.authFun?a.authFun({clientId:a.options.peerId,members:b.members},function(b){if(!b||!b.signature)throw new Error("Conversation creation denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,q.wsSend(a,c)}):q.wsSend(a,c)},q.convAdd=function(a,b){var c={cmd:"conv",op:"add",cid:b.cid,m:b.members,i:b.serialId};a.authFun?a.authFun({clientId:a.options.peerId,members:b.members,convId:b.cid,action:"invite"},function(b){if(!b||!b.signature)throw new Error("Adding members to conversation denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,q.wsSend(a,c)}):q.wsSend(a,c)},q.convRemove=function(a,b){var c={cmd:"conv",op:"remove",cid:b.cid,m:b.members,i:b.serialId};a.authFun&&(b.members.length>1||b.members[0]!=a.options.peerId)?a.authFun({clientId:a.options.peerId,members:b.members,convId:b.cid,action:"kick"},function(b){if(!b||!b.signature)throw new Error("Removing members from conversation denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,q.wsSend(a,c)}):q.wsSend(a,c)},q.send=function(a,b){q.wsSend(a,{cmd:"direct",cid:b.cid,msg:b.data,i:b.serialId,r:b.receipt||!1,"transient":b["transient"]||!1})},q.convQuery=function(a,b){b=b||{};var c=b.where||{};c.m&&"string"!=typeof c.m&&(c.m={$all:c.m}),(c.roomIds||c.convIds)&&(c.objectId={$in:c.roomIds||c.convIds},delete c.roomIds,delete c.convIds),q.wsSend(a,{cmd:"conv",op:"query",where:c,sort:b.sort||"-lm",limit:b.limit||10,skip:b.skip||0,i:b.serialId})},q.querySession=function(a,b){q.wsSend(a,{cmd:"session",op:"query",i:b.serialId,sessionPeerIds:b.peerIdList})},q.convLog=function(a,b){q.wsSend(a,{cmd:"logs",cid:b.cid,t:b.t||void 0,mid:b.mid||void 0,limit:b.limit||20,i:b.serialId})},q.convUpdate=function(a,b){q.wsSend(a,{cmd:"conv",op:"update",cid:b.cid,attr:b.data,i:b.serialId})},q.convAck=function(a,b){q.wsSend(a,{cmd:"ack",cid:b.cid,mid:b.mid})},q.convCount=function(a,b){q.wsSend(a,{cmd:"conv",op:"count",i:b.serialId,cid:b.cid})},q.getMediaMsg=function(a,b){if(!c(b))return a.options.encodeHTML&&(b=e(b)),b;if(b=JSON.parse(b),!b.hasOwnProperty("_lctype"))return b;var d={text:b._lctext,attr:b._lcattrs};switch(a.options.encodeHTML&&(d.text=e(b._lctext)),b._lcfile&&b._lcfile.url&&(d.url=b._lcfile.url),b._lcfile&&b._lcfile.metaData&&(d.metaData=b._lcfile.metaData),b._lctype){case-1:d.type="text";break;case-2:d.type="image";break;case-3:d.type="audio";break;case-4:d.type="video";break;case-5:d.type="location",b._lcloc&&(d.location=b._lcloc);break;case-6:d.type="file";break;default:d=b}return d},q.setMediaMsg=function(a,b,c){var d;if("text"!==b&&!c.metaData)throw new Error("Media Data must have metaData attribute.");switch(b){case"text":d={_lctype:-1,_lctext:c.text,_lcattrs:c.attr};break;case"image":d={_lctype:-2,_lctext:c.text,_lcattrs:c.attr,_lcfile:{url:c.url,objId:c.objectId,metaData:{name:c.metaData.name,format:c.metaData.format,height:c.metaData.height,width:c.metaData.width,size:c.metaData.size}}};break;case"audio":d={_lctype:-3,_lctext:c.text,_lcattrs:c.attr,_lcfile:{url:c.url,objId:c.objectId,metaData:{name:c.metaData.name,format:c.metaData.format,duration:c.metaData.duration,size:c.metaData.size}}};break;case"video":d={_lctype:-4,_lctext:c.text,_lcattrs:c.attr,_lcfile:{url:c.url,objId:c.objectId,metaData:{name:c.metaData.name,format:c.metaData.format,duration:c.metaData.duration,size:c.metaData.size}}};break;case"location":d={_lctype:-5,_lctext:c.text,_lcattrs:c.attr,_lcloc:{longitude:c.metaData.longitude,latitude:c.metaData.latitude}};break;case"file":d={_lctype:-6,_lctext:c.text,_lcattrs:c.attr,_lcfile:{name:c.metaData.name,size:c.metaData.size}}}return d=JSON.stringify(d)},q.getSerialId=function(a){return a.serialId++,a.serialId>999999&&(a.serialId=2015),a.serialId},q.bindEvent=function(a){a.openFlag||(a.ec.on("session-opened",function(b){a.reuseFlag=!1,a.openFlag=!0,a.ec.emit(r.open,b)}),a.ec.on("session-error",function(b){a.ec.emit(r.error,b)}),a.ec.on("conv-joined",function(b){b.peerId!==b.initBy&&a.ec.emit(r.join,b),a.ec.emit(r.invited,b)}),a.ec.on("conv-left",function(b){a.ec.emit(r.left,b),a.ec.emit(r.kicked,b)}),a.ec.on("conv-members-joined",function(b){a.ec.emit(r.join,b),a.ec.emit(r.membersjoined,b)}),a.ec.on("conv-members-left",function(b){a.ec.emit(r.left,b),a.ec.emit(r.membersleft,b)}),a.ec.on("conv-error",function(b){throw a.ec.emit(r.error,b),b.code+":"+b.reason}),a.ec.on("direct",function(b){b.msg=q.getMediaMsg(a,b.msg),b["transient"]||q.convAck(a,{cid:b.cid,mid:b.id}),a.ec.emit(r.message,b)}),a.ec.on("rcp",function(b){a.ec.emit(r.receipt,b)}))},u});
//# sourceMappingURL=bundle.browser.min.js.map