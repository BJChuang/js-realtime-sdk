!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a.AV=a.AV||{},a.AV.realtime=b())}(this,function(){"use strict";function a(a,b){return b={exports:{}},a(b,b.exports),b.exports}function b(){}function c(a){return/^\{.*\}$/.test(a)}function d(){return(new Date).getTime()}function e(a){var b=function(a){return"string"==typeof a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):a};if("object"===("undefined"==typeof a?"undefined":f(a))){for(var c in a)a[c]=tool.encodeHTML(a[c]);return a}return b(a)}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},g="undefined"!=typeof window?window:"undefined"!=typeof g?g:this,h="2.3.5",i=Object.freeze({noop:b,isJSONString:c,now:d,encodeHTML:e}),j=a(function(a,b){b.XMLHttpRequest=window.XMLHttpRequest||window.XDomainRequest}),k=j.XMLHttpRequest,l=function(a,b){"string"==typeof a&&(a={url:a});var c=a.url,d=a.method||"get",e=new k;e.open(d,c),e.onload=function(a){e.status>=200&&e.status<300?b(null,JSON.parse(e.responseText)):b(JSON.parse(e.responseText))},e.onerror=function(a){throw b(a||{}),new Error("Network error.")},e.onprogress=function(){},e.ontimeout=function(){},e.timeout=0;var f=JSON.stringify(a.data);e.send(f)},m=function(){function a(a){var b=[],c=0,d=a.length;if(d){for(;d>c;c++)a[c]&&b.push(a[c]);return b}return null}var b={},c={},d=function(a,d,e){if(!a)throw new Error("No event name.");if(!d)throw new Error("No callback function.");var f,g,h,i=a.split(/\s+/);e&&(g=e.once,h=e.single),f=g?c:b;for(var j=0,k=i.length;k>j;j++)if(i[j]){var l=f[i[j]];if(l||(l=[],f[i[j]]=l),h){for(var m=!1,n=0,o=l.length;o>n;n++)if(l[n].toString()===d.toString()){m=!0;break}m||l.push(d)}else l.push(d)}},e=function(a,d,e){var f,g;if(e&&(g=e.once),f=g?c:b,f[a])for(var h=0,i=f[a].length;i>h;h++)if(f[a][h]===d){f[a][h]=null;break}};return{on:function(a,b){return d(a,b),this},once:function(a,b){return d(a,b,{once:!0}),this},_one:function(a,b){d(a,b,{single:!0})},emit:function(d,f){if(!d)throw new Error("No emit event name.");var g=0,h=0;if(b[d]){for(g=0,h=b[d].length;h>g;g++)b[d][g]&&b[d][g].call(this,f);b[d]=a(b[d])}if(c[d]){for(g=0,h=c[d].length;h>g;g++)c[d][g]&&(c[d][g].call(this,f),e(d,c[d][g],{once:!0}));c[d]=a(c[d])}return this},off:function(a,b){return e(a,b),this}}},n=Object.assign,o={heartbeatsTime:6e4,WebSocket:g.WebSocket||g.MozWebSocket||require("ws")},p={},q={open:"open",reuse:"reuse",close:"close",create:"create",join:"join",left:"left",invited:"invited",kicked:"kicked",membersjoined:"membersjoined",membersleft:"membersleft",message:"message",receipt:"receipt",update:"update",error:"error"},r=function(a){var b=function(b,c,d,e){var f,g,h,i=[];switch("string"==typeof c?i.push(c):i=c,f={cid:b,members:i,serialId:p.getSerialId(a)},e){case"add":h="conv-added",p.convAdd(a,f);break;case"remove":h="conv-removed",p.convRemove(a,f)}return g=function(b){b.i===f.serialId&&(d&&d(b),a.ec.off(h,g))},a.ec.on(h,g),this};return{id:"",attr:{},add:function(a,c){return b(this.id,a,c,"add"),this},remove:function(a,c){return b(this.id,a,c,"remove"),this},join:function(b){return this.add(a.options.peerId,b),this},leave:function(b){return this.remove(a.options.peerId,b),this},send:function(b,c,d){var e,f={},g=this;switch(arguments.length){case 2:e=c;break;case 3:f=c,e=d}if(f.cid=g.id,f.serialId=p.getSerialId(a),f.type?f.data=p.setMediaMsg(a,f.type,b):"string"==typeof b?f.data=b:f.data=JSON.stringify(b),f.receipt&&(f.receipt=1),!f["transient"]){var h=function i(b){b.i===f.serialId&&(e&&e(b),a.ec.off("ack",i))};a.ec.on("ack",h)}return p.send(a,f,e),this},log:function(b,c){var d={};switch(arguments.length){case 1:c=b;break;case 2:d=b}d.cid=d.cid||this.id,d.serialId=d.serialId||p.getSerialId(a);var e=function f(b){if(b.i===d.serialId){if(c){var e=!0,g=!1,h=void 0;try{for(var i,j=b.logs[Symbol.iterator]();!(e=(i=j.next()).done);e=!0){var k=i.value;k.data=p.getMediaMsg(a,k.data),k.fromPeerId=k.from,k.msg=k.data}}catch(l){g=!0,h=l}finally{try{!e&&j["return"]&&j["return"]()}finally{if(g)throw h}}c(b.logs)}a.ec.off("logs",f)}};return a.ec.on("logs",e),p.convLog(a,d),this},receive:function(b){var c=this.id;return a.ec.on(q.message,function(a){c===a.cid&&b(a)}),this},receipt:function(b){var c=this.id;return a.ec.on(q.receipt,function(a){c===a.cid&&b(a)}),this},list:function(b){var c={},d=this.id;c.where={objectId:d},c.serialId=p.getSerialId(a);var e=function f(d){d.i===c.serialId&&(b&&b(d.results.length?d.results[0].m:[]),a.ec.off("conv-results",f))};return a.ec.on("conv-results",e),p.convQuery(a,c),this},count:function(b){var c=this.id,d={cid:c,serialId:p.getSerialId(a)},e=function f(c){c.i===d.serialId&&(b&&b(c.count),a.ec.off("conv-result",f))};return a.ec.on("conv-result",e),p.convCount(a,d),this},update:function(b,c){var d=this.id,e={cid:d,data:b,serialId:p.getSerialId(a)},f=function g(b){b.i===e.serialId&&(c&&c(b),a.ec.off("conv-updated",g))};return a.ec.on("conv-updated",f),p.convUpdate(a,e),this}}},s=function(){var a={options:void 0,ws:void 0,ec:void 0,conv:{},openFlag:!1,closeFlag:!1,reuseTimer:void 0,reuseFlag:!1,serialId:2015};return{clientId:"",cache:a,open:function(a){var b=this,c=this.cache;return c.closeFlag=!1,p.getServer(c,c.options,function(a){a&&p.connect(c,{server:c.server})}),a&&c.ec.once(q.open,a),c.ec.once(q.reuse,function(){c.reuseTimer&&clearTimeout(c.reuseTimer),c.reuseTimer=setTimeout(function(){b.open()},5e3)}),this},close:function(){var a=this.cache;if(!a.openFlag)throw new Error("Must call after open() has successed.");return a.closeFlag=!0,p.closeSession(a),a.ws.close(),this},on:function(a,b){return this.cache.ec.on(a,b),this},once:function(a,b){return this.cache.ec.once(a,b),this},emit:function(a,b){return this.cache.ec.emit(a,b),this},off:function(a,b){return this.cache.ec.off(a,b),this},room:function(a,b){var c=this.cache;if(!c.openFlag)throw new Error("Must call after open() has successed.");var d;if("string"==typeof a){var e=a;d=c.conv[e]?c.conv[e]:r(c),this.query({where:{objectId:e}},function(a){a.length&&(d.id=e,d.name=a[0].name,d.attr=a[0].attr,c.conv[e]=d),b&&b(a.length?d:null)})}else{if(!a)throw new Error("Createing room must have a callback function.");var f;"function"==typeof a?b=a:f=a,f={name:f.name||"",members:f.members||[],attr:f.attr||{},"transient":f["transient"]||!1,unique:f.unique||!1,serialId:p.getSerialId(c)},d=r(c),p.startConv(c,f,b);var g=function h(a){a.i===f.serialId&&(d.id=a.cid,d.name=f.name,d.attr=f.attr,c.conv[d.id]=d,b&&b(d),c.ec.emit(q.create,a),c.ec.off("conv-started",h))};c.ec.on("conv-started",g)}return d},conv:function(){return this.room.apply(this,arguments)},query:function(a,b){var c=this.cache;if(!c.openFlag)throw new Error("Must call after open() has successed.");var d={};switch(arguments.length){case 1:b=a;break;case 2:d=a}d.serialId=p.getSerialId(c);var e=function f(a){a.i===d.serialId&&(b&&b(a.results),c.ec.off("conv-results",f))};return c.ec.on("conv-results",e),d.where||(d.where={},d.where.m=c.options.peerId),p.convQuery(c,d),this},ping:function(a,b){var c=this.cache;if(!c.openFlag)throw new Error("Must call after open() has successed.");if(!b)throw new Error("Ping must have callback.");var d=[];"string"==typeof a?d.push(a):d=a;var e={serialId:p.getSerialId(c),peerIdList:d},f=function g(a){a.i===e.serialId&&(b(a.onlineSessionPeerIds),c.ec.off("session-query-result",g))};return c.ec.on("session-query-result",f),p.querySession(c,e),this}}},t=function(a,b){if("object"!==("undefined"==typeof a?"undefined":f(a)))throw new Error("realtime need a argument at least.");if(!a.appId)throw new Error("Options must have appId.");if(o.WebSocket){var c=o.WebSocket.loadFlashPolicyFile?!1:!0;a={appId:a.appId,peerId:a.clientId,encodeHTML:a.encodeHTML||!1,auth:a.auth,secure:"undefined"==typeof a.secure?c:a.secure,region:a.region||"cn"};var d=s();return d.clientId=a.peerId,d.cache.options=a,d.cache.ec=m(),d.cache.authFun=a.auth,d.open(b),d}console.error("Browser must support WebSocket, please read LeanCloud doc and use plugin.")};return t.version=h,t._tool=i,t._engine=p,t.config=function(a){n(o,a)},p.wsOpen=function(a){p.bindEvent(a),p.openSession(a,{serialId:p.getSerialId(a)}),p.heartbeats(a),p.guard(a)},p.wsClose=function(a,b){a.ec.emit(q.close,b)},p.wsMessage=function(a,b){var c=JSON.parse(b.data);if(c.cmd){var d=c.cmd;c.op&&(d+="-"+c.op),a.ec.emit(d,c)}},p.wsError=function(a,b){throw a.ec.emit(q.error,b),b},p.wsSend=function(a,b){if(!a.closeFlag){if(!a.ws)throw new Error('The realtimeObject must opened first. Please listen to the "open" event.');b.peerId=a.options.peerId,a.ws.send(JSON.stringify(b))}},p.createSocket=function(a,b){a.ws&&a.ws.close();var c=new o.WebSocket(b);a.ws=c,c.addEventListener("open",function(){p.wsOpen(a)}),c.addEventListener("close",function(b){p.wsClose(a,b)}),c.addEventListener("message",function(b){p.wsMessage(a,b)}),c.addEventListener("error",function(b){p.wsError(a,b)})},p.heartbeats=function(a){if(!a.openFlag){var b;a.ws.addEventListener("message",function(){b&&clearTimeout(b),b=setTimeout(function(){a.ws.send("{}")},o.heartbeatsTime)})}},p.guard=function(a){if(!a.openFlag){var b,c=18e4;a.ws.addEventListener("message",function(){b&&clearTimeout(b),b=setTimeout(function(){a.closeFlag||a.reuseFlag||(a.reuseFlag=!0,a.ec.emit(q.reuse))},c)}),a.ec.on(q.close+" session-closed",function(){a.closeFlag||a.reuseFlag||(a.reuseFlag=!0,a.ec.emit(q.reuse))})}},p.connect=function(a,b){var c=b.server;if(!(c&&d()<=c.expires))throw a.ec.emit(q.error),new Error("WebSocket connet failed.");p.createSocket(a,c.server)},p.getServer=function(a,b,c){var e=b.appId,f=b.secure,g="",h="//";f&&(h="https://");var i="";switch(b.region){case"cn":i="g0";break;case"us":i="a0";break;default:throw new Error("There is no this region.")}g=h+"router-"+i+"-push.leancloud.cn/v1/route",g+="?_t="+d()+"&appId="+e,f&&(g+="&secure=1"),l(g,function(b,e){e?(e.expires=d()+1e3*e.ttl,a.server=e,c(e)):a.ec.emit(q.error)})},p.openSession=function(a,b){var c={cmd:"session",op:"open",appId:a.options.appId,ua:"js/"+h,i:b.serialId};a.authFun?a.authFun({clientId:a.options.peerId},function(b){if(!b||!b.signature)throw new Error("Session open denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,p.wsSend(a,c)}):p.wsSend(a,c)},p.closeSession=function(a){p.wsSend(a,a,{cmd:"session",op:"close"})},p.startConv=function(a,b){var c={cmd:"conv",op:"start",m:b.members,attr:{name:b.name||"",attr:b.attr||{}},i:b.serialId,unique:b.unique||!1,"transient":b["transient"]||!1};a.authFun?a.authFun({clientId:a.options.peerId,members:b.members},function(b){if(!b||!b.signature)throw new Error("Conversation creation denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,p.wsSend(a,c)}):p.wsSend(a,c)},p.convAdd=function(a,b){var c={cmd:"conv",op:"add",cid:b.cid,m:b.members,i:b.serialId};a.authFun?a.authFun({clientId:a.options.peerId,members:b.members,convId:b.cid,action:"invite"},function(b){if(!b||!b.signature)throw new Error("Adding members to conversation denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,p.wsSend(a,c)}):p.wsSend(a,c)},p.convRemove=function(a,b){var c={cmd:"conv",op:"remove",cid:b.cid,m:b.members,i:b.serialId};a.authFun&&(b.members.length>1||b.members[0]!=a.options.peerId)?a.authFun({clientId:a.options.peerId,members:b.members,convId:b.cid,action:"kick"},function(b){if(!b||!b.signature)throw new Error("Removing members from conversation denied by application: "+b);c.n=b.nonce,c.t=b.timestamp,c.s=b.signature,p.wsSend(a,c)}):p.wsSend(a,c)},p.send=function(a,b){p.wsSend(a,{cmd:"direct",cid:b.cid,msg:b.data,i:b.serialId,r:b.receipt||!1,"transient":b["transient"]||!1})},p.convQuery=function(a,b){b=b||{};var c=b.where||{};c.m&&"string"!=typeof c.m&&(c.m={$all:c.m}),(c.roomIds||c.convIds)&&(c.objectId={$in:c.roomIds||c.convIds},delete c.roomIds,delete c.convIds),p.wsSend(a,{cmd:"conv",op:"query",where:c,sort:b.sort||"-lm",limit:b.limit||10,skip:b.skip||0,i:b.serialId})},p.querySession=function(a,b){p.wsSend(a,{cmd:"session",op:"query",i:b.serialId,sessionPeerIds:b.peerIdList})},p.convLog=function(a,b){p.wsSend(a,{cmd:"logs",cid:b.cid,t:b.t||void 0,mid:b.mid||void 0,limit:b.limit||20,i:b.serialId})},p.convUpdate=function(a,b){p.wsSend(a,{cmd:"conv",op:"update",cid:b.cid,attr:b.data,i:b.serialId})},p.convAck=function(a,b){p.wsSend(a,{cmd:"ack",cid:b.cid,mid:b.mid})},p.convCount=function(a,b){p.wsSend(a,{cmd:"conv",op:"count",i:b.serialId,cid:b.cid})},p.getMediaMsg=function(a,b){if(!c(b))return a.options.encodeHTML&&(b=e(b)),b;if(b=JSON.parse(b),!b.hasOwnProperty("_lctype"))return b;var d={text:b._lctext,attr:b._lcattrs};switch(a.options.encodeHTML&&(d.text=e(b._lctext)),b._lcfile&&b._lcfile.url&&(d.url=b._lcfile.url),b._lcfile&&b._lcfile.metaData&&(d.metaData=b._lcfile.metaData),b._lctype){case-1:d.type="text";break;case-2:d.type="image";break;case-3:d.type="audio";break;case-4:d.type="video";break;case-5:d.type="location",b._lcloc&&(d.location=b._lcloc);break;case-6:d.type="file";break;default:d=b}return d},p.setMediaMsg=function(a,b,c){var d;if("text"!==b&&!c.metaData)throw new Error("Media Data must have metaData attribute.");switch(b){case"text":d={_lctype:-1,_lctext:c.text,_lcattrs:c.attr};break;case"image":d={_lctype:-2,_lctext:c.text,_lcattrs:c.attr,_lcfile:{url:c.url,objId:c.objectId,metaData:{name:c.metaData.name,format:c.metaData.format,height:c.metaData.height,width:c.metaData.width,size:c.metaData.size}}};break;case"audio":d={_lctype:-3,_lctext:c.text,_lcattrs:c.attr,_lcfile:{url:c.url,objId:c.objectId,metaData:{name:c.metaData.name,format:c.metaData.format,duration:c.metaData.duration,size:c.metaData.size}}};break;case"video":d={_lctype:-4,_lctext:c.text,_lcattrs:c.attr,_lcfile:{url:c.url,objId:c.objectId,metaData:{name:c.metaData.name,format:c.metaData.format,duration:c.metaData.duration,size:c.metaData.size}}};break;case"location":d={_lctype:-5,_lctext:c.text,_lcattrs:c.attr,_lcloc:{longitude:c.metaData.longitude,latitude:c.metaData.latitude}};break;case"file":d={_lctype:-6,_lctext:c.text,_lcattrs:c.attr,_lcfile:{name:c.metaData.name,size:c.metaData.size}}}return d=JSON.stringify(d)},p.getSerialId=function(a){return a.serialId++,a.serialId>999999&&(a.serialId=2015),a.serialId},p.bindEvent=function(a){a.openFlag||(a.ec.on("session-opened",function(b){a.reuseFlag=!1,a.openFlag=!0,a.ec.emit(q.open,b)}),a.ec.on("session-error",function(b){a.ec.emit(q.error,b)}),a.ec.on("conv-joined",function(b){b.peerId!==b.initBy&&a.ec.emit(q.join,b),a.ec.emit(q.invited,b)}),a.ec.on("conv-left",function(b){a.ec.emit(q.left,b),a.ec.emit(q.kicked,b)}),a.ec.on("conv-members-joined",function(b){a.ec.emit(q.join,b),a.ec.emit(q.membersjoined,b)}),a.ec.on("conv-members-left",function(b){a.ec.emit(q.left,b),a.ec.emit(q.membersleft,b)}),a.ec.on("conv-error",function(b){throw a.ec.emit(q.error,b),b.code+":"+b.reason}),a.ec.on("direct",function(b){b.msg=p.getMediaMsg(a,b.msg),b["transient"]||p.convAck(a,{cid:b.cid,mid:b.id}),a.ec.emit(q.message,b)}),a.ec.on("rcp",function(b){a.ec.emit(q.receipt,b)}))},t});
//# sourceMappingURL=bundle.browser.min.js.map